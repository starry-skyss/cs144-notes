# Checkpoint 6 Note：Router（Longest-Prefix Match）

## 目标（Goal）
实现一个多网卡 IP 路由器：对每个入站 IPv4 数据报执行最长前缀匹配选路，正确处理 TTL，并从指定接口转发到下一跳。

## 关键不变量 / 核心概念
- **Longest-Prefix Match（LPM）**：在所有匹配路由中选择 `prefix_length` 最大的一条（最具体网段优先）。
- **匹配语义是“高位 bit 匹配”**：`/k` 表示比较目的地址与前缀的最高 `k` 位，而不是低位。
- **直连路由 next_hop 为空**：下一跳应取数据报的最终目的地址（dst），而不是某个固定网关。
- **TTL 规则**：TTL<=1 的包必须丢弃；可转发的包必须先 TTL-- 再发送。
- **无匹配即丢弃**：路由表里找不到匹配项时不发送，避免产生随机行为或错误转发。
- **路由表条目可并存**：同一 `route_prefix` 可以出现不同 `prefix_length`（例如 /8 与 /16），LPM 依赖这类“层级”规则。

## 边界条件
- **默认路由 `/0`**：应匹配所有目的地址，并在无更具体匹配时作为兜底。
- **主机路由 `/32`**：只匹配一个精确目的地址。
- **TTL=0 / TTL=1**：必须丢弃，不能发送（TTL-- 后为 0 的也应丢弃）。
- **未命中任何路由**：必须丢弃，不能使用未初始化的出接口编号。
- **多条匹配路由并存**：必须选最长前缀（例如 /16 覆盖 /8）。
- **掩码构造位移边界**：`k=0` 与 `k=32` 时需要特殊处理，避免 `<< 32` 的未定义行为。
- **直连 vs 非直连**：`next_hop` 为空与非空两条路径应严格区分，否则会把直连网络错误地发给网关或反之。
- **接口号合法性**：路由条目中的 `interface_num` 必须对应已添加接口，否则 `at()` 会抛异常（表现为测试中断）。

## 调试复盘
### Bug 1：无匹配仍发送，导致随机崩溃/乱发包
- **现象**：`check6` 测试中偶发崩溃或出现明显不合理的转发结果；有时是 `vector::at` 越界异常。
- **定位**：发现代码在扫描路由表后无条件调用 `send_datagram()`；而出接口变量 `interface_n` 在未匹配时从未赋值。
- **结论**：必须引入 `found` 标志（或等价机制），仅当找到匹配路由后才允许发送；未命中必须丢弃。

### Bug 2：`uint8_t len = -1` 导致 LPM 失效
- **现象**：存在更具体路由（更长前缀）时仍走了较短前缀或“第一个匹配项”，表现为选路不符合最长前缀原则。
- **定位**：`len` 使用 `uint8_t` 并初始化为 `-1`，发生无符号转换变成 255，导致 `prefix_length > len` 永远为 false。
- **结论**：不要用无符号类型承载 `-1` 哨兵值；改为 `uint8_t best_len=0` 并配合 `!found` 处理首次命中。
